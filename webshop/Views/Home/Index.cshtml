@model IEnumerable<webshop.Models.Product>

<h1>Catalog</h1>

<div>
    <form method="get" asp-comtroller="Home" asp-action="Index">
        <div class="name__search__container">
            <input type="text" name="name" placeholder="Найти товар" value="@ViewBag.SelectedName" list="nameList" onchange="this.form.submit()" autocomplete="off" />
            <datalist id="nameList">
                @foreach (var name in ViewBag.Names)
                {
                    <option value="@name"></option>
                }
            </datalist>
        </div>


        <input type="text" name="category" placeholder="Категория" value="@ViewBag.SelectedCategory" list="categoryList" autocomplete="off" />
        <datalist id="categoryList">
            @foreach (var cat in ViewBag.Categories)
            {
                <option value="@cat"></option>
            }
        </datalist>

        <input type="number" name="minPrice" placeholder="Мин. цена" value="@ViewBag.MinPrice" autocomplete="off" />
        <input type="number" name="maxPrice" placeholder="Макс. цена" value="@ViewBag.MaxPrice" autocomplete="off" />
        <button type="submit">Фильтр</button>
    </form>
</div>

<div id="product-list" class="products" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;"></div>

<div id="loading" style="display: none; text-align: center; margin: 20px;">
    <p>Загрузка...</p>
</div>

<script>
    let skip = $('.product-card').length;
    const take = 12;
    let isLoading = false;
    let hasMore = true;

    function getFilters() {
        return {
            category: $('input[name="category"]').val(),
            name: $('input[name="name"]').val(),
            minPrice: $('input[name="minPrice"]').val(),
            maxPrice: $('input[name="maxPrice"]').val()
        };
    }

    function loadProducts() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        const filters = getFilters();

        $.get('/Home/LoadProducts', { ...getFilters(), skip, take }, function (response) {
            if (response.products && response.products.length > 0) {
                response.products.forEach((product, index) => {
                    let productCard = $(`
                    <div class="product-card" style="border: 1px solid #ccc; padding: 15px;">
                        <img src="/images/Products/${product.image}" alt="${product.name}" style="max-width: 100%;" />
                        <h3>${product.name}</h3>
                        <p>${product.description}</p>
                        <p>${product.price} р.</p>
                    </div>
                `);

                    if (response.isAuthenticated) {
                        const forms = $(`
                        <form action="/Home/Details" method="get">
                            <input type="hidden" name="id" value="${product.id}" />
                            <button type="submit" class="btn btn-link btn-sm">Просмотреть товар</button>
                        </form>
                        <form action="/Cart/AddToCart" method="post">
                            <input type="hidden" name="productId" value="${product.id}" />
                            <div class="form-group">
                                <label>Количество:</label>
                                <input type="number" name="quantity" value="1" min="1" class="form-control" style="width: 100px;" />
                            </div>
                            <button type="submit" class="btn btn-primary">Добавить в корзину</button>
                        </form>
                    `);

                        productCard.append(forms);
                    }

                    $('#product-list').append(productCard);

                    setTimeout(() => productCard.addClass('show'), index * 100);
                });

                skip += take;
                hasMore = response.hasMore;
            } else {
                hasMore = false;
            }

            isLoading = false;
        });

    }

    $(window).scroll(function () {
        if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
            loadProducts();
        }
    });

    $(document).ready(function () {
        loadProducts();

        $('form').on('submit', function (e) {
            e.preventDefault();
            $('#product-list').empty();  // Очищаем список перед новым поиском
            skip = 0;
            hasMore = true;
            loadProducts();
        });
    });
</script>